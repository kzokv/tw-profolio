name: Deploy via Cloudflare WARP
on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Install WARP
        run: |
          set -euxo pipefail
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update
          sudo apt-get install -y cloudflare-warp
      - name: Configure WARP MDM
        run: |
          set -euxo pipefail
          sudo mkdir -p /var/lib/cloudflare-warp
          sudo tee /var/lib/cloudflare-warp/mdm.xml >/dev/null <<EOF
          <dict>
              <key>auth_client_id</key>
              <string>${{ secrets.CF_ACCESS_CLIENT_ID }}</string>
              <key>auth_client_secret</key>
              <string>${{ secrets.CF_ACCESS_CLIENT_SECRET }}</string>
              <key>auto_connect</key>
              <integer>1</integer>
              <key>onboarding</key>
              <false/>
              <key>organization</key>
              <string>${{ secrets.CF_TEAM_NAME }}</string>
              <key>service_mode</key>
              <string>warp</string>
          </dict>
          EOF
      - name: Start and connect WARP
        run: |
          set -euxo pipefail
          sudo systemctl enable --now warp-svc
          warp-cli --accept-tos registration new
          warp-cli --accept-tos connect
          connected=false
          for _ in $(seq 1 12); do
            status="$(warp-cli --accept-tos status || true)"
            printf '%s\n' "$status"
            if printf '%s\n' "$status" | grep -Eq 'Status update: Connected|Success'; then
              connected=true
              break
            fi
            sleep 5
          done
          if [ "$connected" != true ]; then
            echo "ERROR: WARP did not reach a connected state" >&2
            warp-cli --accept-tos status || true
            exit 1
          fi
          warp-cli --accept-tos status
          warp-cli --accept-tos settings
      - name: Verify route to deploy host
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          set -euxo pipefail
          target_host="${DEPLOY_HOST:-192.168.2.66}"
          ip route
          nc -vz -w 10 "$target_host" 22
      - name: Install SSH key
        run: |
          set -euxo pipefail
          install -m 700 -d ~/.ssh
          printf '%s\n' "${{ secrets.DEPLOY_SSH_PRIVATE_KEY || secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
      - name: Write SSH config
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          set -euxo pipefail
          target_host="${DEPLOY_HOST:-192.168.2.66}"
          target_user="${DEPLOY_USER:-ubuntu}"
          cat > ~/.ssh/config <<EOF
          Host deploy-target
            HostName ${target_host}
            User ${target_user}
            IdentityFile ~/.ssh/id_ed25519
            ServerAliveInterval 30
            ServerAliveCountMax 4
            StrictHostKeyChecking accept-new
          EOF
      - name: Verify SSH access
        run: |
          set -euxo pipefail
          ssh -o BatchMode=yes -o ConnectTimeout=30 deploy-target 'hostname && whoami'
      - name: Run remote deploy
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_BRANCH: main
          DEPLOY_IMAGE_TAG: latest
        run: |
          set -euxo pipefail
          remote_user="${DEPLOY_USER:-ubuntu}"
          remote_path="${DEPLOY_PATH:-/home/${remote_user}/tw-portfolio}"
          ssh deploy-target "DEPLOY_PATH='$remote_path' DEPLOY_BRANCH='$DEPLOY_BRANCH' DEPLOY_IMAGE_TAG='$DEPLOY_IMAGE_TAG' bash -s" <<'EOF'
          set -euxo pipefail
          cd "$DEPLOY_PATH"
          git rev-parse --is-inside-work-tree
          git remote -v
          bash infra/scripts/deploy.sh --branch "$DEPLOY_BRANCH" --image-tag "$DEPLOY_IMAGE_TAG"
          EOF
      - name: Cleanup SSH credentials
        if: always()
        run: rm -f ~/.ssh/id_ed25519 ~/.ssh/config ~/.ssh/known_hosts
