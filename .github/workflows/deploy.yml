name: Deploy via Cloudflare WARP
on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main, dev]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install WARP
        run: >
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg
          --yes --dearmor --output
          /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg

          echo "deb
          [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg]
          https://pkg.cloudflareclient.com $(lsb_release -cs) main" | sudo tee
          /etc/apt/sources.list.d/cloudflare-client.list

          sudo apt-get update

          sudo apt-get install -y cloudflare-warp
      - name: Configure WARP MDM
        run: |
          sudo mkdir -p /var/lib/cloudflare-warp
          sudo tee /var/lib/cloudflare-warp/mdm.xml >/dev/null <<EOF
          <dict>
              <key>auth_client_id</key>
              <string>${{ secrets.CF_ACCESS_CLIENT_ID }}</string>
              <key>auth_client_secret</key>
              <string>${{ secrets.CF_ACCESS_CLIENT_SECRET }}</string>
              <key>auto_connect</key>
              <integer>1</integer>
              <key>onboarding</key>
              <false/>
              <key>organization</key>
              <string>${{ secrets.CF_TEAM_NAME }}</string>
              <key>service_mode</key>
              <string>warp</string>
          </dict>
          EOF
      - name: Start WARP
        run: |
          sudo systemctl enable --now warp-svc
          sleep 10
          warp-cli --accept-tos status || true
      - name: Install SSH key
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
      - name: Trust target host key
        run: |
          ssh-keyscan -H 192.168.2.66 >> ~/.ssh/known_hosts
      - name: Test SSH over WARP
        run: >
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes
          ubuntu@192.168.2.66 'hostname && whoami'
